"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { AlertTriangle, Shield, Activity, TrendingUp } from "lucide-react"
import { useEffect, useState } from "react"

interface VulnerabilityStats {
  total: number
  critical: number
  high: number
  medium: number
  low: number
  open: number
  inProgress: number
  patched: number
  exploitAvailable: number
}

interface VulnerabilityStatsLiveProps {
  initialStats: VulnerabilityStats
}

export function VulnerabilityStatsLive({ initialStats }: VulnerabilityStatsLiveProps) {
  const [stats, setStats] = useState(initialStats)
  const [recentActivity, setRecentActivity] = useState<string[]>([])

  useEffect(() => {
    const eventSource = new EventSource("/api/sse")

    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)
        if (data.type === "vulnerability") {
          // Update stats based on new vulnerability
          setStats((prev) => ({
            ...prev,
            total: prev.total + 1,
            critical: data.data.severity === "Critical" ? prev.critical + 1 : prev.critical,
            high: data.data.severity === "High" ? prev.high + 1 : prev.high,
            medium: data.data.severity === "Medium" ? prev.medium + 1 : prev.medium,
            low: data.data.severity === "Low" ? prev.low + 1 : prev.low,
            open: data.data.status === "Open" ? prev.open + 1 : prev.open,
          }))

          // Add to recent activity
          setRecentActivity((prev) => [
            `${data.data.severity} vulnerability detected: ${data.data.cve}`,
            ...prev.slice(0, 4),
          ])
        }
      } catch (error) {
        console.error("Failed to parse SSE data:", error)
      }
    }

    return () => {
      eventSource.close()
    }
  }, [])

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      <Card className="border-red-500/30 bg-gradient-to-br from-red-950/20 to-[#1a1a1a]">
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-sm font-medium text-gray-400">
            <AlertTriangle className="h-4 w-4 text-red-500" />
            Critical Vulnerabilities
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-3xl font-bold text-red-500">{stats.critical}</div>
          <p className="mt-1 text-xs text-gray-500">Requires immediate attention</p>
        </CardContent>
      </Card>

      <Card className="border-orange-500/30 bg-gradient-to-br from-orange-950/20 to-[#1a1a1a]">
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-sm font-medium text-gray-400">
            <TrendingUp className="h-4 w-4 text-orange-500" />
            High Severity
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-3xl font-bold text-orange-500">{stats.high}</div>
          <p className="mt-1 text-xs text-gray-500">Priority patching required</p>
        </CardContent>
      </Card>

      <Card className="border-yellow-500/30 bg-gradient-to-br from-yellow-950/20 to-[#1a1a1a]">
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-sm font-medium text-gray-400">
            <Activity className="h-4 w-4 text-yellow-500" />
            Medium Severity
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-3xl font-bold text-yellow-500">{stats.medium}</div>
          <p className="mt-1 text-xs text-gray-500">Schedule for remediation</p>
        </CardContent>
      </Card>

      <Card className="border-cyan-500/30 bg-gradient-to-br from-cyan-950/20 to-[#1a1a1a]">
        <CardHeader className="pb-2">
          <CardTitle className="flex items-center gap-2 text-sm font-medium text-gray-400">
            <Shield className="h-4 w-4 text-cyan-500" />
            Total Vulnerabilities
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-3xl font-bold text-cyan-400">{stats.total}</div>
          <div className="mt-2 flex gap-2">
            <Badge variant="outline" className="border-green-500 text-green-400">
              {stats.patched} Patched
            </Badge>
            <Badge variant="outline" className="border-blue-500 text-blue-400">
              {stats.inProgress} In Progress
            </Badge>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
